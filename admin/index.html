<!doctype html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ayarlar</title>
    <style>
      body { font-family: Arial, sans-serif; padding: 2rem; background: #f5f5f5; }
      form, table { background: #fff; padding: 1rem; border-radius: 8px; }
      table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
      th, td { padding: 0.5rem; border-bottom: 1px solid #ddd; }
      .actions button { margin-right: 0.5rem; }
      .status { margin-bottom: 1rem; }
      .pill {
        display: inline-block;
        padding: 2px 6px;
        border-radius: 12px;
        background: #555;
        color: #fff;
        font-size: 0.85rem;
      }
    </style>
  </head>
  <body>
    <h1>Ayarlar</h1>
    <div class="status" id="status"></div>
    <form id="settings-form">
      <label>Key: <input name="key" required /></label>
      <label>Value: <input name="value" required /></label>
      <label>Description: <input name="description" /></label>
      <label><input type="checkbox" name="secret" /> Gizli alan</label>
      <button type="submit">Kaydet</button>
    </form>

    <table>
      <thead>
        <tr><th>Key</th><th>Value</th><th>Gizli?</th><th>Description</th><th>Güncellendi</th><th>Actions</th></tr>
      </thead>
      <tbody id="settings-body"></tbody>
    </table>

    <script>
      const apiBase = (window.API_BASE_URL || '') + '/api/settings';

      const statusEl = document.getElementById('status');
      const form = document.getElementById('settings-form');
      const bodyEl = document.getElementById('settings-body');

      async function fetchSettings() {
        status('Yükleniyor...');
        const res = await fetch(apiBase);
        const data = await res.json();
        renderTable(data.settings || []);
        status('Kaydedilmiş ayarlar yüklendi.');
      }

      function status(text, isError) {
        statusEl.textContent = text;
        statusEl.style.color = isError ? 'red' : 'inherit';
      }

      function renderTable(settings) {
        bodyEl.innerHTML = '';
        settings.forEach((item) => {
          const row = document.createElement('tr');
          const keyCell = document.createElement('td');
          keyCell.textContent = item.key;

          const valueCell = document.createElement('td');
          if (item.masked) {
            const pill = document.createElement('span');
            pill.className = 'pill';
            pill.textContent = 'gizli';
            valueCell.appendChild(pill);
          } else {
            valueCell.textContent = item.value;
          }

          const secretCell = document.createElement('td');
          secretCell.textContent = item.masked ? 'Evet' : 'Hayır';

          const descCell = document.createElement('td');
          descCell.textContent = item.description || '';

          const updatedCell = document.createElement('td');
          updatedCell.textContent = item.updatedAt || '';

          const actionsCell = document.createElement('td');
          actionsCell.className = 'actions';
          const editBtn = document.createElement('button');
          editBtn.dataset.action = 'edit';
          editBtn.textContent = 'Düzenle';
          const deleteBtn = document.createElement('button');
          deleteBtn.dataset.action = 'delete';
          deleteBtn.textContent = 'Sil';
          actionsCell.appendChild(editBtn);
          actionsCell.appendChild(deleteBtn);

          row.appendChild(keyCell);
          row.appendChild(valueCell);
          row.appendChild(secretCell);
          row.appendChild(descCell);
          row.appendChild(updatedCell);
          row.appendChild(actionsCell);
          row.dataset.id = item.id;
          row.dataset.masked = item.masked;
          row.dataset.secret = item.secret;
          bodyEl.appendChild(row);
        });
      }

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(form);
        const existingRow = bodyEl.querySelector('tr[data-editing="true"]');
        const payload = {
          key: (formData.get('key') || '').trim(),
          value: (formData.get('value') || '').trim(),
          description: (formData.get('description') || '').trim(),
          secret: form.secret.checked,
        };

        if (!payload.description) delete payload.description;
        if (existingRow && !payload.value) delete payload.value;
        if (!existingRow && !payload.value) {
          status('Value zorunludur', true);
          return;
        }

        const method = existingRow ? 'PUT' : 'POST';
        const targetId = existingRow ? existingRow.dataset.id : '';
        const res = await fetch(`${apiBase}/${targetId}`, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!res.ok) {
          const err = await res.json();
          status(err.message || 'Hata oluştu', true);
          return;
        }
        form.reset();
        form.value.placeholder = '';
        form.secret.checked = false;
        if (existingRow) existingRow.removeAttribute('data-editing');
        await fetchSettings();
      });

      bodyEl.addEventListener('click', async (e) => {
        const action = e.target.dataset.action;
        if (!action) return;
        const row = e.target.closest('tr');
        const id = row.dataset.id;
        if (action === 'delete') {
          if (!confirm('Ayarı sil ve türev artefaktları temizle?')) return;
          const res = await fetch(`${apiBase}/${id}`, { method: 'DELETE' });
          if (!res.ok) {
            status('Silme başarısız', true);
            return;
          }
          await fetchSettings();
          return;
        }
        if (action === 'edit') {
          row.dataset.editing = 'true';
          form.key.value = row.children[0].textContent;
          form.description.value = row.children[3].textContent;
          form.secret.checked = row.dataset.secret === 'true';
          if (row.dataset.masked === 'true') {
            form.value.value = '';
            form.value.placeholder = 'Yeni değer girin';
          } else {
            form.value.value = row.children[1].textContent;
            form.value.placeholder = '';
          }
          status('Düzenleme modunda');
        }
      });

      fetchSettings().catch((err) => status(err.message, true));
    </script>
  </body>
</html>
