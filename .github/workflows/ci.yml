name: CI

on:
  push:
    branches: ["main", "master"]
  pull_request:

jobs:
  admin:
    name: Admin lint & tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: admin
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
      - name: Install dependencies
        run: npm ci
      - name: Prepare env file
        run: cp .env.example .env
      - name: Run lint
        run: npm run lint
      - name: Run tests
        run: npm test

  server:
    name: Server lint & tests (with MySQL)
    runs-on: ubuntu-latest
    services:
      mysql:
        image: mysql:8
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: argex_gps
          MYSQL_USER: argex
          MYSQL_PASSWORD: argex
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h localhost -uargex -pargex"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    defaults:
      run:
        working-directory: server
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
      - name: Install dependencies
        run: npm ci
      - name: Prepare env file
        run: cp .env.example .env
      - name: Wait for database
        run: >-
          node -e "const mysql=require('mysql2');
          const wait=()=>new Promise((res,rej)=>{
            const c=mysql.createConnection({host:'127.0.0.1',user:'argex',password:'argex',database:'argex_gps'});
            c.connect(err=>{if(err){setTimeout(()=>wait().then(res).catch(rej),1000);c.destroy();}else{c.end();res();}});
          }); wait();"
      - name: Run lint
        env:
          DATABASE_URL: mysql://argex:argex@127.0.0.1:3306/argex_gps
        run: npm run lint
      - name: Run tests
        env:
          DATABASE_URL: mysql://argex:argex@127.0.0.1:3306/argex_gps
        run: npm test

  mobile:
    name: Mobile lint & tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: mobile
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
      - name: Install dependencies
        run: npm install
      - name: Prepare env file
        run: cp .env.example .env
      - name: Run lint
        run: npm run lint
      - name: Run tests
        run: npm test
